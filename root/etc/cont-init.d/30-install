#!/usr/bin/with-contenv bash

# Clone directory, If Directory Exists, Git Pull
if [[ ! -d /config/www/monitorr/.git ]]; then
  git clone -b docker-test --single-branch https://github.com/Monitorr/monitorr.git /config/www/monitorr
elif [[ -d /config/www/monitorr/.git ]]; then
  cd /config/www/monitorr || return
  git pull
fi

# Make Directories
# USER DATA
if [[ ! -d /app/userdata/ ]]; then
  mkdir /app/userdata/ # Dir for User Data
elif [[ -d /app/userdata/ ]]; then
  echo '-----------------------------------------------'
  echo '| The Directory /app/userdata/ already exists |'
  echo '-----------------------------------------------'
else
  :
fi

if [[ ! -e /app/datadir.json ]]; then
  echo 'No datadir detected...'
  echo 'Creating datadir.json'
  cp /datadir.json /app/datadir.json
  echo 'Linking datadir to monitorr...'
  ln -s /app/datadir.json /config/www/monitorr/assets/data/datadir.json
  echo '--------------------------------'
  echo 'Moving *usrimg* to */app/images*'
  mv /config/www/monitorr/assets/data/usrimg/ /app/images
  echo 'Linking *app/images* to Monitorr'
  ln -s  /app/images /config/www/monitorr/assets/data/usrimg
  echo '----------------------------'
  echo 'Moving *logs* to */app/logs*'
  mv /config/www/monitorr/assets/data/logs /app/logs
  echo 'Linking */app/logs* to Monitorr'
  ln -s  /app/logs /config/www/monitorr/assets/data/logs
  echo '-------------------------------'
  echo 'Moving *css* file to */app/css*'
  mv /config/www/monitorr/assets/data/css /app/css
  echo 'Linking */app/css* to Monitorr'
  ln -s  /app/css /config/www/monitorr/assets/data/css
  echo '------------------------------------'
  echo 'Insert Monitorr Data File Warning Text'
  cp /config/www/monitorr/assets/config/_installation/default/monitorr_data_directory_default.txt /app/userdata/monitorr_data_directory.txt
  sleep 2
  echo 'Installation Complete. Thanks for using Monitorr!'
elif [[ -e /app/datadir.json ]]; then
  echo '--------------------------------------'
  echo '| We have detected /app/datadir.json |'
  echo '--------------------------------------'
  echo '. . .'
  sleep 1
  echo '---------------------------------------'
  echo '| Cleaning data directory for data... |'
  echo '---------------------------------------'
  echo '. . .'
  sleep 1
  rm -rf /config/www/monitorr/assets/data/usrimg
  rm -rf /config/www/monitorr/assets/data/logs
  rm -rf /config/www/monitorr/assets/data/css
  rm -rf /config/www/monitorr/assets/data/datadir.json
  echo '-------------------------------------'
  echo '| User Data Directory link clean... |'
  echo '-------------------------------------'
  echo '. . .'
  sleep 1
  echo '-------------------------------'
  echo '| Relinking previous install! |'
  echo '-------------------------------'
  sleep 3
  ln -s  /app/datadir.json /config/www/monitorr/assets/data/datadir.json
  ln -s  /app/images /config/www/monitorr/assets/data/usrimg
  ln -s  /app/logs /config/www/monitorr/assets/data/logs
  ln -s  /app/css /config/www/monitorr/assets/data/css
  echo 'Previous install linked. . .'
  echo 'Complete!'
else
  :
fi


# Permissions
chown -R abc:abc /config
chown -R abc:abc /app
chmod -R 777 /app/userdata/
chmod -R 777 /config/www/monitorr/assets/data/
